# Piccy Plan

## Product Goal

Build a fast image sharing web app that beats Discord's GIF-explorer flow for speed:

- paste (`Ctrl+V` / `Cmd+V`), drag-drop, or click upload
- immediately get a shareable public link
- one-click copy for direct URL / Markdown / BBCode
- authenticated users can manage their own uploads
- all infrastructure runs on Cloudflare

## Core Decisions

- Frontend: SolidJS + Vite
- Runtime/API: Cloudflare Workers + Hono
- Object storage: Cloudflare R2 (public access via custom domain)
- Relational metadata: Cloudflare D1 (via Drizzle ORM beta)
- Auth: Better Auth (recommended over OpenAuth for this project)
- Image optimization runtime: Cloudflare Containers (queued background jobs)

### Auth Method

Magic link (email-based passwordless login) only. No OAuth providers or password-based auth for MVP. Keeps the auth UI minimal (single email input + "check your inbox" flow).

## UX Requirements

- fast first interaction (<1s on warm navigation)
- paste-to-link-copied target p95 <2.5s for common image sizes
- no forced modal flow after upload
- keyboard-first behavior:
  - `Ctrl+V`/`Cmd+V` uploads from clipboard
  - `Enter` confirms focused actions
  - `c` copies selected image link in library view

## Cloudflare Architecture

- Single Worker app hosts API and static frontend assets
- R2 bucket stores image binaries (public-read via custom domain)
- D1 stores metadata, ownership, and usage analytics
- Queue orchestrates async jobs (WebP optimization, EXIF extraction, semantic indexing)
- Cloudflare Container worker performs heavy image processing (WebP + thumbnails now, GIF optimization later)
- Scheduled Worker (Cron Trigger) runs cleanup jobs (expired anonymous uploads, soft-deleted R2 objects)

### R2 Key Structure

All objects stored under a flat ULID-based scheme:

- Original: `{ulid}/original.{ext}`
- WebP variant: `{ulid}/webp.webp`
- Thumbnail: `{ulid}/thumb.webp`

This avoids collisions, keeps variants grouped, and makes cleanup straightforward (delete by prefix).

## Data Model (D1)

### Better Auth tables

- generated by Better Auth migrations (user, session, account, verification, etc.)

### App tables

1. `uploads`

- `id` TEXT PRIMARY KEY (ULID)
- `owner_user_id` TEXT NULL
- `expires_at` TEXT NULL (set for anonymous uploads, NULL for authenticated)
- `r2_key` TEXT NOT NULL UNIQUE
- `public_url` TEXT NOT NULL
- `mime_type` TEXT NOT NULL
- `size_bytes` INTEGER NOT NULL
- `thumb_r2_key` TEXT NULL
- `webp_r2_key` TEXT NULL
- `webp_size_bytes` INTEGER NULL
- `optimization_status` TEXT NOT NULL DEFAULT 'pending'
- `optimized_at` TEXT NULL
- `width` INTEGER NULL
- `height` INTEGER NULL
- `sha256` TEXT NULL
- `copy_count` INTEGER NOT NULL DEFAULT 0
- `created_at` TEXT NOT NULL
- `updated_at` TEXT NOT NULL
- `deleted_at` TEXT NULL

2. `upload_copy_events` (recommended for analytics integrity)

- `id` TEXT PRIMARY KEY
- `upload_id` TEXT NOT NULL
- `actor_user_id` TEXT NULL
- `copied_format` TEXT NOT NULL (`direct`, `markdown`, `bbcode`)
- `copied_at` TEXT NOT NULL
- `source` TEXT NOT NULL (`uploader`, `library`, `detail`)

Indexes:

- `idx_uploads_owner_created` on (`owner_user_id`, `created_at` DESC)
- `idx_uploads_created` on (`created_at` DESC)
- `idx_uploads_expires_at` on (`expires_at`) WHERE `expires_at` IS NOT NULL
- `idx_upload_copy_events_upload_copied_at` on (`upload_id`, `copied_at` DESC)

### Drizzle Implementation Status (2026-02-17)

- Added Drizzle schema at `src/db/schema.ts` for `uploads` and `upload_copy_events` (including indexes and FK cascade)
- Added migration generation config at `drizzle.config.ts` (output directory: `./migrations`)
- Added remote D1 push config at `drizzle.push.config.ts` using Drizzle `d1-http` driver
- Added scripts: `bun --bun run db:generate` and `bun --bun run db:push`
- Generated initial migration: `migrations/20260217122038_brave_alex_wilder/migration.sql`
- `db:push` requires `CLOUDFLARE_ACCOUNT_ID`, `CLOUDFLARE_DATABASE_ID` (or `DB_ID`), and `CLOUDFLARE_D1_TOKEN` (or `CLOUDFLARE_API_TOKEN`)

## API Contract (MVP)

- `POST /api/uploads`
  - accepts multipart image upload
  - validates MIME, extension, file signature, max size
  - stores object in R2
  - inserts metadata row in D1
  - returns `id`, `directUrl`, `markdown`, `bbcode`

- `POST /api/uploads/:id/copy`
  - increments `uploads.copy_count`
  - inserts row in `upload_copy_events`
  - body: `{ format, source }`
  - client debounces: one tracking call per upload per format within 5s window

- `GET /api/me/uploads?cursor=...`
  - auth required
  - returns user's uploads with pagination

- `DELETE /api/me/uploads/:id`
  - auth required
  - soft delete row (`deleted_at` set), R2 objects cleaned up later by scheduled worker

- Better Auth routes (magic link only)
  - `GET|POST /api/auth/*`

## Frontend Feature Plan (Tanstack Solid Start)

### Upload Surface

- big paste/drop target always visible
- hidden file input for click-to-upload
- clipboard handler reads `ClipboardEvent.clipboardData.items`
- local preview shown immediately
- upload progress bar
- auto-copy on success with fallback if Clipboard API blocked

### Share Output

- direct URL (default)
- Markdown format: `![image](url)`
- BBCode format: `[img]url[/img]`
- toast feedback for copied state

### Library (Authenticated)

- list/grid toggle
- sort by newest / most copied
- quick actions: copy direct, copy markdown, copy bbcode, delete
- per-image copy count visible

## Anonymous Upload Lifecycle

- anonymous uploads get `expires_at` set to 30 days from creation
- scheduled Worker (Cron Trigger) runs daily to:
  1. query uploads where `expires_at < now` and `deleted_at IS NULL`
  2. delete R2 objects (original + variants by prefix)
  3. hard-delete the D1 row
- authenticated users can claim anonymous uploads (future, not MVP)

## Soft-Delete Cleanup

- `DELETE /api/me/uploads/:id` sets `deleted_at` on the D1 row; links stop resolving immediately
- same scheduled Worker also cleans up soft-deleted uploads:
  1. query uploads where `deleted_at < now - 7 days`
  2. delete R2 objects by ULID prefix
  3. hard-delete the D1 row
- 7-day grace period allows undo in a future iteration

## Security + Abuse Controls

- strict server-side MIME + magic-byte validation
- enforce upload size limit (MVP: 15 MB)
- R2 keys are derived from ULID only (no user input in key path, no traversal possible)
- rate limiting per IP and per user
- optional Turnstile gate for anonymous spikes
- CORS restricted to app origin(s)
- ownership checks on all manage/delete endpoints

## Performance Plan

- optimize client bundle for quick first paint
- use direct Worker->R2 write for originals, then async WebP generation via queue+container
- set response headers: `ETag`, `Cache-Control: public, max-age=31536000, immutable`
- lazy-load library views below fold
- optional client-side compression for oversized images
- collect basic latency metrics (upload duration, copy-latency, failures)

## Image Optimization (Pre-Semantic Search)

- upload path stays fast: store original immediately and return link without blocking
- enqueue `optimize-image` job after successful upload
- process job in Cloudflare Container (libvips/sharp) to generate WebP derivative + thumbnail (max 400px wide, WebP)
- write optimized objects to R2 and update D1 (`webp_r2_key`, `webp_size_bytes`, `thumb_r2_key`, `optimization_status`)
- serve WebP by default when available, fallback to original while optimization is pending/failed
- serve thumbnails in library grid view for fast loading
- preserve original for compatibility and future re-processing

## Semantic Search (Phase 2, Deferred)

- enqueue upload jobs after write success
- generate captions/keywords (Workers AI)
- generate embeddings (Workers AI)
- store vectors in Vectorize
- add `GET /api/search?q=...` semantic retrieval

Not in MVP, but schema and pipeline should remain compatible.

## GIF Optimization (Post-Semantic Search)

- add dedicated optimization pipeline for animated GIF inputs
- containerized processing with FFmpeg/gifsicle to produce smaller WebM/MP4/optimized GIF outputs
- keep GIF compatibility link while preferring modern formats for sharing/perf
- add per-format output stats in D1 for quality/size tuning

## Comprehensive TODO List

### Phase 0 - Project Bootstrap

- [ ] Add Cloudflare Worker integration for serving app + API
- [ ] Configure `wrangler.jsonc` with current `compatibility_date`
- [ ] Add required bindings: D1 (`DB`), R2 (`IMAGES_BUCKET`)
- [ ] Enable Better Auth runtime requirements (`nodejs_compat`/ALS)
- [ ] Add environment management for local/dev/prod

### Phase 1 - Database + Auth Foundation

- [x] Create D1 database and initial migrations folder
- [x] Set up Drizzle ORM beta for D1 schema, queries, and migrations
- [ ] Implement Better Auth config for Cloudflare Worker runtime
- [ ] Mount Better Auth handler at `/api/auth/*`
- [ ] Run Better Auth schema migrations (programmatic or CLI-compatible setup)
- [ ] Add auth client integration on frontend
- [ ] Configure magic link email transport (e.g. Resend, Mailchannels)
- [ ] Implement auth UI (email input, "check your inbox" state, sign out)

### Phase 2 - Upload MVP

- [ ] Implement `POST /api/uploads`
- [ ] Add R2 object upload with metadata persistence in D1
- [ ] Build upload button flow
- [ ] Build drag-drop flow
- [ ] Build clipboard paste flow (`Ctrl+V` / `Cmd+V`)
- [ ] Add upload progress + error states
- [ ] Add post-upload auto-copy behavior
- [ ] Show direct URL + Markdown + BBCode outputs

### Phase 3 - Copy Tracking + Library

- [x] Add `copy_count` to uploads table
- [x] Create `upload_copy_events` table and indexes
- [ ] Implement `POST /api/uploads/:id/copy`
- [ ] Trigger copy tracking on all copy actions in UI
- [ ] Implement `GET /api/me/uploads` with pagination
- [ ] Build library UI (grid view, copy actions, load more)
- [ ] Add sort by most copied / newest

### Phase 4 - Management + Hardening

- [ ] Implement soft-delete endpoint and UI action
- [ ] Add ownership guards and authorization checks
- [ ] Add rate limiting middleware
- [ ] Add file size/type policy enforcement and explicit error messaging
- [ ] Add retry strategy for transient upload failures
- [ ] Add telemetry events for upload/copy performance
- [ ] Add scheduled Worker (Cron Trigger) for cleanup:
- [ ] Purge expired anonymous uploads (R2 + D1)
- [ ] Purge soft-deleted uploads past grace period (R2 + D1)

### Phase 5 - Cloudflare Production Setup

- [ ] Configure R2 public domain (custom domain preferred)
- [ ] Set CORS policy for R2 bucket
- [ ] Set Worker routes and production domain
- [ ] Add Wrangler secrets and verify `wrangler whoami`
- [ ] Add CI deploy pipeline (build + deploy)
- [ ] Validate remote behavior with `wrangler dev --remote`

### Phase 6 - Containerized Image Optimization (WebP)

- [ ] Set up Cloudflare Container worker for image processing jobs
- [ ] Add Queue producer/consumer flow for optimization jobs
- [ ] Generate WebP variants + thumbnails (max 400px wide, WebP) in container and upload back to R2
- [ ] Add D1 metadata updates for optimization status + variant keys + thumb key
- [ ] Serve WebP by default with fallback to original
- [ ] Serve thumbnails in library grid view
- [ ] Add retry/dead-letter handling for failed optimizations

### Phase 7 - Optional Semantic Search

- [ ] Create Queue for async indexing jobs
- [ ] Add Workers AI caption + embedding generation
- [ ] Add Vectorize index and ingestion worker path
- [ ] Build semantic query endpoint and UI search box
- [ ] Add relevance tuning + fallback keyword filtering

### Phase 8 - GIF Optimization (After Semantic Search)

- [ ] Add GIF detection and routing to animation optimization pipeline
- [ ] Implement containerized FFmpeg/gifsicle transcoding jobs
- [ ] Produce modern animated outputs (WebM/MP4) plus optional optimized GIF
- [ ] Add UI/share logic to prefer best output format by client capability
- [ ] Track GIF optimization metrics (size reduction, processing latency, failures)

## Acceptance Criteria (MVP)

- user can paste an image and receive copied direct link in one flow
- user can upload by button and drag-drop
- authenticated user can browse own uploads and see copy counts
- copy actions increment and persist count reliably
- all storage and compute are Cloudflare-native

## Risks / Mitigations

- Better Auth migration friction in Worker runtime -> use Cloudflare-compatible migration path from start
- clipboard API browser differences -> implement graceful fallback + explicit copy button
- upload abuse -> rate limits, size caps, optional Turnstile
- R2 public URL strategy drift -> standardize on custom domain early
- Cloudflare Containers beta stability -> isolate optimization pipeline behind queue + robust fallback to originals
